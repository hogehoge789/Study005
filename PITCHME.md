## KVMについて
勉強会資料    
by GitPitch

---

Kernel-based Virtual Machine  

Qumranetという会社で開発  
2008年にRedHatに買収  

+++

CPUの仮想化支援機能を前提に設計  

AWSのEC2インスタンスとしても採用  
➔C5、M5  

---

### CPUの動作モード  
リングプロテクション  
Ring0 カーネルモード
Ring3 ユーザーモード

Ring0は特権命令を出せる  
Ring3は特権命令を直接出せない  

+++

仮想環境の場合はこの仕組みだけでは足りない  
ゲストOSの特権命令をホストで検知して処理する必要がある  
  
「センシティブ命令」をホストでトラップさせる |

+++

### 完全仮想化  
- ゲストOSに変更は加えない |
- センシティブ命令はバイナリトランスレーションという命令にVMMが変換して処理 |

### 準仮想化  
- ゲストOSをカスタマイズ |
- センシティブ命令をハイパーバイザコールという命令で直接VMMへ渡す |

+++

### CPUの仮想化支援機能
センシティブ命令をVMMやゲストOSでなくCPUで解決するアプローチ  
Intel VT-x  
AMD-v 

リングプロテクションモデルはそのままで  
ホスト側とゲスト側を分離させる。

+++

ホスト(VMM)のモード：VMX rootモード  
ゲストマシンのモード：VMX non-rootモード  


センシティブ命令を出す際はrootモードに遷移して実行する  
☆バイナリトランスレーション程のオーバヘッドがなく、OS改変も不要

---

#### QEMU
QEMUはハードウェアのエミュレータ  
KVMでも利用されている  

CPUの仮想化については前述のCPU仮想化技術を利用し、
それ以外の部分でQEMUを使っている。
(メモリやディスクI/Oの仮想化など)

VMの管理機能としてlibvirtを採用している。

