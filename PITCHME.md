## KVMについて
勉強会資料  


by GitPitch
---

Kernel-based Virtual Machine  

2006年にQumranetが開発  
2008年にRedHatに買収  

+++

CPUの仮想化支援機能を前提に設計  

AWSのEC2インスタンスとしても採用  
➔C5、M5  

---

### CPUの動作モード  
リングプロテクション  
Ring0：カーネルモード  
Ring3：ユーザーモード  

- Ring0は特権命令を出せる |
- Ring3は特権命令を直接出せない |

+++

仮想環境だとこれだけでは足りない  
  
ゲストOSの特権命令を検知して処理する  
  
- 「センシティブ命令」をホストでトラップさせる |

+++

### 完全仮想化  
- ゲストOSに変更は加えない |
- センシティブ命令はバイナリトランスレーションという命令にVMMが変換して処理 |

+++

### 準仮想化  
- ゲストOSをカスタマイズ |
- センシティブ命令をハイパーバイザコールという命令で直接VMMへ渡す |

+++

### CPUの仮想化支援機能
センシティブ命令をVMMやゲストOSでなくCPUで解決するアプローチ  
- Intel VT-x
- AMD-v
  
- リングプロテクションモデルはそのまま |
- ホストの処理とゲストの処理を分離させる |

+++

#### ホスト(VMM)のモード：VMX rootモード  
#### ゲストマシンのモード：VMX non-rootモード  

- センシティブ命令をゲストで実行させる |
- 実行を検知したらrootモードに遷移して実行される |

+++

バイナリトランスレーションのようなオーバヘッドがなく、OS改変も不要

+++

non-rootモードへの遷移をVM-Entry  
rootモードへの遷移をVM-Exit  

<img src="img/img002.png">

---

### QEMU
QEMUはハードウェアのエミュレータ  
KVM以前から開発・利用  

+++
従来のQEMUではセンシティブ命令を判定  
  
KVMはCPUでセンシティブ命令をフックするため判定が不要で高速化を実現

+++

CPUの仮想化については前述のCPU仮想化技術を利用しそれ以外の部分でQEMUを使っている  
(メモリやディスクI/Oの仮想化など)  

VMの管理機能としてlibvirtを採用している。

+++

<img src="img/img001.png">

+++

---?image=img/img001.png
