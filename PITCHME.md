## KVMについて
勉強会用資料 by GitPitch

Kernel-based Virtual Machine  

---
CPUの仮想化支援機構を前提に設計

Qumranetという会社で開発され、  
2008年にRedHatに買収される。

AWSのEC2インスタンスとしても採用  
➔C5、M5  

#### 仮想化の実行モード
完全仮想化(バイナリトランスレーション)  
準仮想化  

完全仮想化➔VMware  
準仮想化➔Xen  

センシティブ命令  
➔ホスト側の状態を変更させる命令

#### CPUの動作モード  
リングプロテクション  
Ring0 カーネルモード
Ring3 ユーザーモード

Ring0は特権命令を出せる  

Ring3は特権命令をカーネルに依頼して出してもらう  
➔システムコール  

---

#### 実行モード

既出のRingプロテクション(カーネルモード、ユーザーモード)の仕組みとは別にハイパーバイザ向けのプロテクションモデルを導入。
これにより、ハイパーバイザのモードとゲストマシンのモードで分離する形となった。  

ゲストモードを追加。  
ゲストモードにある時はセンシティブ命令をCPUがトラップしてカーネルに渡す。

Intel VT-xの前提  

ハイパーバイザのモード：VMX rootモード  
ゲストマシンのモード：VMX non-rootモード  

VMX rootモードでのRing0/Ring3  
VMX non-rootモードでのRing0/Ring3  

rootモードはVMMが稼働する際のCPUモード  
non-rootモードは仮想マシンに関連する処理を実行する際のCPUモード  

ホストの特権命令が必要な場合(センシティブ命令を出す場合)はnon-rootモードに遷移して実行される  
☆バイナリトランスレーション程のオーバヘッドがなく、OS改変も不要

xenのdom0、domU  

---

#### QEMU
QEMUはハードウェアのエミュレータ  
KVMでも利用されている  

CPUの仮想化については前述のCPU仮想化技術を利用し、
それ以外の部分でQEMUを使っている。
(メモリやディスクI/Oの仮想化など)

VMの管理機能としてlibvirtを採用している。

